<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../../genindex.html" /><link rel="search" title="Search" href="../../../../search.html" /><link rel="next" title="Test and Measurement class" href="../../../AN00135_test_and_measurement_class/doc/rst/AN00135.html" /><link rel="prev" title="CDC EDC class" href="../../../AN00131_CDC_EDC_class/doc/rst/AN00131.html" />

    <meta name="generator" content="sphinx-3.5.4, furo 2021.04.11.beta34"/>
        <title>Image class - Keith&#39;s Docs 23.2.17 documentation</title>
      <link rel="stylesheet" href="../../../../_static/styles/furo.css?digest=59ab60ac09ea94ccfe6deddff6d715cce948a6fc">
    <link rel="stylesheet" href="../../../../_static/pygments.css">
    <link media="(prefers-color-scheme: dark)" rel="stylesheet" href="../../../../_static/pygments_dark.css">
    


<style>
  :root {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
  }

  /* For allowing end-user-specific overrides */
  .override-light {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  .override-dark {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
  }
</style><link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/tabs.css" />
    <link rel="stylesheet" href="../../../../_static/styles/furo-extensions.css?digest=d391b54134226e4196576da3bdb6dddb7e05ba2b"></head>
  <body dir="">
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke-width="1.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z"/>
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../../index.html"><div class="brand">Keith's Docs 23.2.17 documentation</div></a>
    </div>
    <div class="header-right">
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand centered" href="../../../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../../../_static/xmos_logo.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Keith's Docs 23.2.17 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../../search.html">
  <input class="sidebar-search" placeholder=Search name="q">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../doc/rst/before_you_start.html">Before you start</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label for="toctree-checkbox-1"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/version_info.html">Tool and Architecture Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/inc_changelog.html">lib_xud Change Log</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/inc_license.html">XMOS PUBLIC LICENCE: Version 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/inc_copyrights.html">Copyright</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/inc_contributions.html">How to contribute</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/build_the_documentation_yourself.html">How to build the documenation</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../lib_xud/doc/rst/the_xud_library.html">The XUD library</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label for="toctree-checkbox-2"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib_xud/doc/rst/overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib_xud/doc/rst/file_arrangement.html">File Arrangement</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib_xud/doc/rst/resource_usage.html">Resource Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib_xud/doc/rst/basic_usage.html">Basic Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib_xud/doc/rst/advanced_usage.html">Advanced Usage</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../../../doc/usb_class_examples.html">USB Class examples</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label for="toctree-checkbox-3"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../AN00124_CDC_VCOM_class/doc/rst/AN00124.html">CDC VCOM class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00125_mass_storage_class/doc/rst/AN00125.html">Mass Storage class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00126_printer_class/doc/rst/AN00126.html">Printer class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00127_video_class/doc/rst/AN00127.html">Video class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00129_hid_class/doc/rst/AN00129.html">HID class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00131_CDC_EDC_class/doc/rst/AN00131.html">CDC EDC class</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Image class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00135_test_and_measurement_class/doc/rst/AN00135.html">Test and Measurement class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00136_vendor_specific/doc/rst/AN00136.html">Vendor Sepcific (Custom USB device)</a></li>
</ul>
</li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <main class="main">
    <div class="content">
      <article role="main">
        <label class="toc-overlay-icon toc-content-icon" for="__toc">
          <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
        </label>
        <div class="section" id="image-class">
<h1>Image class<a class="headerlink" href="#image-class" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<div class="section" id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h3>
<p>The Universal Serial Bus (USB) is a communications architecture that gives a PC the ability to interconnect a variety of devices via a simple four-wire cable. One such device is the digital still camera.</p>
<p>This application note gives a simple example for interfacing a USB still image capture device with a USB host. In the example, the USB transactions implemented for image capture are compliant to the Picture Transfer Protocol (PTP) of Photographic and Imaging Manufacturers Association (PIMA) 15470 standard <a class="footnote-reference brackets" href="#id3" id="id1">1</a>. An image simulated at xCORE is transferred to the host.</p>
<p>The USB specification provides a standard device class for the implementation of
USB still image capture device <a class="footnote-reference brackets" href="#id4" id="id2">2</a>.</p>
</div>
<div class="section" id="block-diagram">
<h3>Block diagram<a class="headerlink" href="#block-diagram" title="Permalink to this headline">¶</a></h3>
<div class="figure align-center" id="id9">
<a class="reference internal image-reference" href="../../../../_images/block_diagram6.png"><img alt="../../../../_images/block_diagram6.png" src="../../../../_images/block_diagram6.png" style="width: 100%;"/></a>
<p class="caption"><span class="caption-number">Fig. 47 </span><span class="caption-text">Block diagram of USB still image capture device application example</span><a class="headerlink" href="#id9" title="Permalink to this image">¶</a></p>
</div>
<dl class="footnote brackets">
<dt class="label" id="id3"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p><a class="reference external" href="http://www.pima.net/standards/it10/IT10_POW.htm">http://www.pima.net/standards/it10/IT10_POW.htm</a></p>
</dd>
<dt class="label" id="id4"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p><a class="reference external" href="http://www.usb.org/developers/docs/devclass_docs/usb_still_img10.zip">http://www.usb.org/developers/docs/devclass_docs/usb_still_img10.zip</a></p>
</dd>
</dl>
</div>
</div>
<div class="section" id="usb-still-image-capture-device-application-note">
<h2>USB Still Image Capture Device Application Note<a class="headerlink" href="#usb-still-image-capture-device-application-note" title="Permalink to this headline">¶</a></h2>
<p>The demo in this note uses the XMOS USB Device (XUD) library and shows a simple program for interfacing a USB still image capture device. It responds to device control and image data transfer requests from the host PC.</p>
<p>For the USB still image capture class application example, the system comprises three tasks running on separate logical cores of a xCORE-USB multicore microcontroller. The tasks perform the following operations.</p>
<blockquote>
<div><ul class="simple">
<li><p>A task containing the USB library functionality to communicate over USB</p></li>
<li><p>A task implementing Endpoint0 responding to standard USB control requests</p></li>
<li><p>A task implementing the application code for device interface</p></li>
</ul>
</div></blockquote>
<p>These tasks communicate via the xCONNECT channels which allow data to be passed between application codes running on separate logical cores.</p>
<p>The following diagram shows the task and communication structure for this USB still image capture device class application example.</p>
<div class="figure align-center" id="id10">
<a class="reference internal image-reference" href="../../../../_images/task_diagram5.png"><img alt="../../../../_images/task_diagram5.png" src="../../../../_images/task_diagram5.png" style="width: 50%;"/></a>
<p class="caption"><span class="caption-number">Fig. 48 </span><span class="caption-text">Task diagram of USB still image capture device interface</span><a class="headerlink" href="#id10" title="Permalink to this image">¶</a></p>
</div>
<p>The still image capture class has an interrupt endpoint as well to report the asynchronous events occuring at the device to the host. The demo in this note however emulates the image capture device. The interrupt endpoint is therefore not implemented although it is instantiated in Endpoint0. Application developers can implement this endpoint when a real image capture device is connected.</p>
<div class="section" id="makefile-additions-for-this-example">
<h3>Makefile additions for this example<a class="headerlink" href="#makefile-additions-for-this-example" title="Permalink to this headline">¶</a></h3>
<p>To start using the USB library, you need to add <code class="docutils literal notranslate"><span class="pre">lib_usb</span></code> to your makefile:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">USED_MODULES</span> <span class="o">=</span> <span class="o">...</span> <span class="n">lib_usb</span> <span class="o">...</span>
</pre></div>
</div>
<p>You can then access the USB functions in your source code via the xud.h header file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;usb.h&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="declaring-resource-and-setting-up-the-usb-components">
<h3>Declaring resource and setting up the USB components<a class="headerlink" href="#declaring-resource-and-setting-up-the-usb-components" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">main.xc</span></code> contains the application implementation for a USB still image capture device.
There are some defines in it that are used to configure the XMOS USB device library. These are displayed below.</p>
<p>These defines describe the endpoint configuration for this device. This example has bi-directional communication with the host machine via the standard Endpoint0 and an endpoint for implementing the still image capture class bulk data endpoint which is also bi-directional. The endpoint type tables inform XUD what the transfer types for each endpoint in use and also if the endpoint wishes to be informed of USB bus resets.</p>
<p>These defines are passed to the setup function for the USB library which is called
from <code class="docutils literal notranslate"><span class="pre">main()</span></code>.</p>
</div>
<div class="section" id="the-application-main-function">
<h3>The application main() function<a class="headerlink" href="#the-application-main-function" title="Permalink to this headline">¶</a></h3>
<p>Below is the source code for the main function of this application, which is taken from the source file <code class="docutils literal notranslate"><span class="pre">main.xc</span></code></p>
<p>Looking at this in a more detail you can see the following:</p>
<blockquote>
<div><ul class="simple">
<li><p>The par functionality describes running three separate tasks in parallel</p></li>
<li><p>There is a function call to configure and execute the USB library: <code class="docutils literal notranslate"><span class="pre">xud()</span></code></p></li>
<li><p>There is a function call to startup and run the Endpoint0 code: <code class="docutils literal notranslate"><span class="pre">Endpoint0()</span></code></p></li>
<li><p>There is a function to deal with the bulk endpoints for command and data transfer: <code class="docutils literal notranslate"><span class="pre">bulk_endpoint()</span></code></p></li>
<li><p>The define USB_TILE describes the tile on which the individual tasks will run</p></li>
<li><p>In this example all tasks run on the same tile as the USB PHY although this is only a requirement of <code class="docutils literal notranslate"><span class="pre">xud()</span></code></p></li>
<li><p>The xCONNECT communication channels used by the application are set up in the beginning of <code class="docutils literal notranslate"><span class="pre">main()</span></code></p></li>
<li><p>The USB defines discussed earlier are passed to the function <code class="docutils literal notranslate"><span class="pre">xud()</span></code></p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="configuring-the-usb-device-id">
<h3>Configuring the USB Device ID<a class="headerlink" href="#configuring-the-usb-device-id" title="Permalink to this headline">¶</a></h3>
<p>The USB ID values used for Vendor ID, Product ID and device version number are defined in the file <code class="docutils literal notranslate"><span class="pre">endpoint0.xc</span></code>. These are used by the host machine to determine the vendor of the device (in this case XMOS) and the product plus the firmware version.</p>
</div>
<div class="section" id="usb-still-image-capture-class-specific-defines">
<h3>USB Still Image Capture Class specific defines<a class="headerlink" href="#usb-still-image-capture-class-specific-defines" title="Permalink to this headline">¶</a></h3>
<p>The USB Still Image Capture Class is configured in the file <code class="docutils literal notranslate"><span class="pre">endpoint0.xc</span></code>.
Below there are a set of class-specific defines and requests which are used to configure the USB device descriptors to setup a USB still image capture device running on an xCORE-USB microcontroller.</p>
<p>These are defined in the USB standard as required in the device definition for
still image capture devices and for configuring them as such with the USB host machine.</p>
</div>
<div class="section" id="usb-device-descriptor">
<h3>USB Device Descriptor<a class="headerlink" href="#usb-device-descriptor" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">endpoint0.xc</span></code> is where the standard USB device descriptor is declared for a still image capture device. Below is the structure which contains this descriptor. This will be requested by the host when the device is enumerated on the USB bus.</p>
<p>From this descriptor you can see that product, vendor and device firmware revision are all coded into this structure. This will allow the host machine to recognise our still image device when it is connected to the USB bus.</p>
</div>
<div class="section" id="usb-configuration-descriptor">
<h3>USB Configuration Descriptor<a class="headerlink" href="#usb-configuration-descriptor" title="Permalink to this headline">¶</a></h3>
<p>The USB configuration descriptor is used to configure the device  class and the endpoint setup. For the USB still image capture device provided in this example the configuration descriptor which is read by the host is as follows.</p>
<p>This decriptor is in the format decribed by the USB 2.0 standard. It contains the encoding for the endpoints related to control endpoint 0 and the descriptors that describe the two bulk endpoints for data in and out. It also contains the descriptors for the interrupt endpoint. The bulk endpoints are used for transferring image data and non-image data to adjust device controls. The interrupt endpoint is used to send asynchronous event data such as battery low indication or the removal of the memory card to the host from the device.</p>
</div>
<div class="section" id="usb-string-descriptors">
<h3>USB string descriptors<a class="headerlink" href="#usb-string-descriptors" title="Permalink to this headline">¶</a></h3>
<p>The final descriptor for our still image capture device is the string descriptor which the host machine uses to report to the user when the device is enumerated and when the user queries the device on the host system. This is setup as follows.</p>
</div>
<div class="section" id="usb-still-image-capture-class-requests">
<h3>USB Still Image Capture Class requests<a class="headerlink" href="#usb-still-image-capture-class-requests" title="Permalink to this headline">¶</a></h3>
<p>Inside <code class="docutils literal notranslate"><span class="pre">endpoint0.xc</span></code> there is some code for handling the USB image capture device class-specific requests. These are shown in the following code:</p>
<p>These class-specific requests are implemented by the application as they do not form part of the standard requests which have to be accepted by all device classes via endpoint0.</p>
</div>
<div class="section" id="usb-still-image-capture-class-endpoint0">
<h3>USB Still Image Capture Class Endpoint0<a class="headerlink" href="#usb-still-image-capture-class-endpoint0" title="Permalink to this headline">¶</a></h3>
<p>The function <code class="docutils literal notranslate"><span class="pre">Endpoint0()</span></code> contains the code for dealing with device requests made from the host to the standard endpoint 0 which is present in all USB devices.
In addition to requests required for all devices, the code handles the requests specific to the still image capture device class.</p>
</div>
<div class="section" id="handling-requests-to-the-bulk-endpoints">
<h3>Handling requests to the bulk endpoints<a class="headerlink" href="#handling-requests-to-the-bulk-endpoints" title="Permalink to this headline">¶</a></h3>
<p>The application endpoints for receiving commands and transmitting data and response to the host machine are implemented in the file <code class="docutils literal notranslate"><span class="pre">main.xc</span></code>. This is contained within the function <code class="docutils literal notranslate"><span class="pre">bulk_endpoint()</span></code> which is shown below:</p>
<p>From this you can see the following.</p>
<blockquote>
<div><ul class="simple">
<li><p>Three buffers <code class="docutils literal notranslate"><span class="pre">cmd_buf</span></code>, <code class="docutils literal notranslate"><span class="pre">info_buf</span></code> and <code class="docutils literal notranslate"><span class="pre">data_buf</span></code> are declared to communicate with the host for receiving commands and transferring data</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">while</span> <span class="pre">(1)</span></code> loop which repeatedly deals with a sequence of PTP-compliant operation requests from the host, send image data and response to the device. Commands are processed and an image is autogenerated.</p></li>
<li><p>In each iteration, a PTP command is processed in <code class="docutils literal notranslate"><span class="pre">switch-case</span></code> statements and an appropriate response is sent</p></li>
<li><p>A gray or color gradient image is generated for the command <code class="docutils literal notranslate"><span class="pre">OC_GetImage</span></code>. The image type and the starting gray or color component values are defined in the beginning of <code class="docutils literal notranslate"><span class="pre">main.xc</span></code></p></li>
<li><p>A blocking call is made to the XMOS USB device library to receive command (using <code class="docutils literal notranslate"><span class="pre">XUD_GetBuffer</span></code>) and send data as well the response (using <code class="docutils literal notranslate"><span class="pre">XUD_SetBuffer</span></code>) to the host machine at every loop iteration</p></li>
<li><p>This simple processing could easily be extended to access an image capture device connected to the xCORE GPIO or communicate with another parallel task</p></li>
</ul>
</div></blockquote>
<p><a href="#id14"><span class="problematic" id="id15">|appendix|</span></a></p>
</div>
</div>
<div class="section" id="example-hardware-setup">
<h2>Example Hardware Setup<a class="headerlink" href="#example-hardware-setup" title="Permalink to this headline">¶</a></h2>
<p>To run the example, connect the xCORE-USB sliceKIT USB-B and xTAG-2 USB-A
connectors to separate USB connectors on your development PC.</p>
<div class="figure align-default" id="id11">
<img alt="../../../../_images/usb-slicekit6.png" src="../../../../_images/usb-slicekit6.png"/>
<p class="caption"><span class="caption-number">Fig. 49 </span><span class="caption-text">XMOS xCORE-USB sliceKIT</span><a class="headerlink" href="#id11" title="Permalink to this image">¶</a></p>
</div>
<p>The hardware should be configured as displayed above for this demo:</p>
<blockquote>
<div><ul class="simple">
<li><p>The XTAG debug adapter should be connected to the XSYS connector and
the XTAG USB cable should be connected to the host machine</p></li>
<li><p>The xCORE-USB core board should have a USB cable connecting the device
to the host machine</p></li>
<li><p>The xCORE-USB core board should have the power cable connected</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="host-application-setup">
<h2>Host Application Setup<a class="headerlink" href="#host-application-setup" title="Permalink to this headline">¶</a></h2>
<div class="section" id="test-application">
<h3>Test application<a class="headerlink" href="#test-application" title="Permalink to this headline">¶</a></h3>
<p>This simple host example demonstrates simple PTP transactions between
the host processor and the XMOS device in bulk transfer mode.</p>
<p>The application simply sends commands for receiving the image size and the type and then sends a request to get the image.
It receives a response for each command and also the image data. The received image data is stored in a file and displayed.</p>
<p>The application was tested on a 64-bit linux platform. The binary and ‘libusb’ library for this platform along with the source files of the application are provided in the <code class="docutils literal notranslate"><span class="pre">host</span></code> directory. For other platforms,
please refer to the application note AN00136: USB Vendor Specific Device <a class="footnote-reference brackets" href="#id7" id="id5">3</a>.</p>
</div>
<div class="section" id="licensing">
<h3>Licensing<a class="headerlink" href="#licensing" title="Permalink to this headline">¶</a></h3>
<p>libusb is written in C and licensed under the LGPL-2.1.</p>
</div>
<div class="section" id="compilation-instructions">
<h3>Compilation instructions<a class="headerlink" href="#compilation-instructions" title="Permalink to this headline">¶</a></h3>
<p>If you require to recompile the test program then the instruction to do so is below,</p>
<p>Linux64:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">g</span><span class="o">++</span> <span class="o">-</span><span class="n">o</span> <span class="n">get_image</span> <span class="o">../</span><span class="n">get_image</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span><span class="n">I</span> <span class="o">../</span><span class="n">libusb</span><span class="o">/</span><span class="n">Linux64</span> <span class="o">../</span><span class="n">libusb</span><span class="o">/</span><span class="n">Linux64</span><span class="o">/</span><span class="n">libusb</span><span class="o">-</span><span class="mf">1.0</span><span class="o">.</span><span class="n">a</span> <span class="o">-</span><span class="n">lpthread</span> <span class="o">-</span><span class="n">lrt</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="launching-the-demo-application">
<h2>Launching the demo application<a class="headerlink" href="#launching-the-demo-application" title="Permalink to this headline">¶</a></h2>
<p>Once the demo example has been built either from the command line using
xmake or via the build mechanism of xTIMEcomposer studio the applcation
can be executed on the xCORE-USB sliceKIT.</p>
<p>Once built there will be a <code class="docutils literal notranslate"><span class="pre">bin</span></code> directory within the project which
contains the binary for the xCORE device. The xCORE binary has a XMOS standard
.xe extension.</p>
<div class="section" id="launching-from-the-command-line">
<h3>Launching from the command line<a class="headerlink" href="#launching-from-the-command-line" title="Permalink to this headline">¶</a></h3>
<p>From the command line the <code class="docutils literal notranslate"><span class="pre">xrun</span></code> tool is used to download code to the
xCORE-USB device. Changing into the bin directory of the project
the code can be executed on the xCORE microcontroller as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">xrun</span> <span class="n">app_usb_image_demo</span><span class="o">.</span><span class="n">xe</span>          <span class="o">&lt;--</span> <span class="n">Download</span> <span class="ow">and</span> <span class="n">execute</span> <span class="n">the</span> <span class="n">xCORE</span> <span class="n">code</span>
</pre></div>
</div>
<p>Once this command has executed the vendor specific USB device should have
enumerated on the host machine</p>
</div>
<div class="section" id="launching-from-xtimecomposer-studio">
<h3>Launching from xTIMEcomposer Studio<a class="headerlink" href="#launching-from-xtimecomposer-studio" title="Permalink to this headline">¶</a></h3>
<p>From xTIMEcomposer Studio the run mechanism is used to download code to the
xCORE device. Select the xCORE binary from the bin directory, right click
and then run as xCORE application will execute the code on the xCORE device.</p>
<p>Once this command has executed the still image USB device should have
enumerated on your machine. You can check this by executing ‘lsusb’ from the command line. It lists the device like the one below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Bus</span> <span class="mi">001</span> <span class="n">Device</span> <span class="mi">007</span><span class="p">:</span> <span class="n">ID</span> <span class="mi">20</span><span class="n">b1</span><span class="p">:</span><span class="mi">00</span><span class="n">c1</span> <span class="n">XMOS</span> <span class="n">Ltd</span>
</pre></div>
</div>
</div>
<div class="section" id="running-the-host-demo">
<h3>Running the host demo<a class="headerlink" href="#running-the-host-demo" title="Permalink to this headline">¶</a></h3>
<p>To run the example, navigate to ‘host/Linux64’ and execute ‘./get_image’ from the command line.</p>
<p>This will connect to the USB device running on the xCORE microcontroller and
transfer data buffers back and forth.</p>
<p>The demo prompts the user for the inputs - image size and type. The output of the demo is as below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">XMOS</span> <span class="n">USB</span> <span class="n">image</span> <span class="n">device</span> <span class="n">opened</span> <span class="o">.....</span>
<span class="n">Session</span> <span class="n">opened</span> <span class="o">....</span>
<span class="n">Image</span> <span class="n">captured</span> <span class="o">....</span>
<span class="n">Image</span> <span class="n">info</span> <span class="n">got</span> <span class="o">....</span>
<span class="n">Image</span> <span class="n">written</span> <span class="n">to</span> <span class="n">PNM</span> <span class="ow">and</span> <span class="n">JPG</span> <span class="n">files</span> <span class="o">.....</span>
<span class="n">Displaying</span> <span class="n">image</span> <span class="o">.....</span>
<span class="n">Session</span> <span class="n">closed</span> <span class="o">....</span>
<span class="n">XMOS</span> <span class="n">USB</span> <span class="n">image</span> <span class="n">device</span> <span class="n">closed</span> <span class="o">.....</span>
</pre></div>
</div>
<p>The gradient image received by the host is first saved in PNM <a class="footnote-reference brackets" href="#id8" id="id6">4</a> format and then converted to a JPG file. The image is displayed. PNM is portable anymap format that was designed to be easily exchanged between platforms. It can be one of these: portable pixmap format (PPM), portable graymap format (PGM) and portable bitmap format (PBM).
Sample output gray image files <code class="docutils literal notranslate"><span class="pre">image.pnm</span></code> and <code class="docutils literal notranslate"><span class="pre">image.jpg</span></code> are in the <code class="docutils literal notranslate"><span class="pre">host/Linux64</span></code> directory. The generated color and gray images are shown in Figures 4 and 5.</p>
<div class="figure align-default" id="id12">
<img alt="../../../../_images/color_image.png" src="../../../../_images/color_image.png"/>
<p class="caption"><span class="caption-number">Fig. 50 </span><span class="caption-text">Color image</span><a class="headerlink" href="#id12" title="Permalink to this image">¶</a></p>
</div>
<div class="figure align-default" id="id13">
<img alt="../../../../_images/gray_image.png" src="../../../../_images/gray_image.png"/>
<p class="caption"><span class="caption-number">Fig. 51 </span><span class="caption-text">Gray image</span><a class="headerlink" href="#id13" title="Permalink to this image">¶</a></p>
</div>
<dl class="footnote brackets">
<dt class="label" id="id7"><span class="brackets"><a class="fn-backref" href="#id5">3</a></span></dt>
<dd><p><a class="reference external" href="https://www.xmos.com/download/public/AN00136%3A-USB-Vendor-Specific-Device%281.0.0%29.pdf">https://www.xmos.com/download/public/AN00136%3A-USB-Vendor-Specific-Device%281.0.0%29.pdf</a></p>
</dd>
<dt class="label" id="id8"><span class="brackets"><a class="fn-backref" href="#id6">4</a></span></dt>
<dd><p><a class="reference external" href="http://en.wikipedia.org/wiki/Netpbm_format">http://en.wikipedia.org/wiki/Netpbm_format</a></p>
</dd>
</dl>
</div>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="full-source-code-listing">
<h2>Full source code listing<a class="headerlink" href="#full-source-code-listing" title="Permalink to this headline">¶</a></h2>
<div class="section" id="source-code-for-endpoint0-xc">
<h3>Source code for endpoint0.xc<a class="headerlink" href="#source-code-for-endpoint0-xc" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="source-code-for-main-xc">
<h3>Source code for main.xc<a class="headerlink" href="#source-code-for-main-xc" title="Permalink to this headline">¶</a></h3>
</div>
</div>
</div>

      </article>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../../../AN00135_test_and_measurement_class/doc/rst/AN00135.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Test and Measurement class</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../../../AN00131_CDC_EDC_class/doc/rst/AN00131.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">CDC EDC class</div>
                
              </div>
            </a>
        </div>

        <div class="related-information">
              Copyright &#169; 2021, XMOS Ltd
            |
            Built with <a href="https://www.sphinx-doc.org/">Sphinx</a>
              and
              <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
              <a href="https://github.com/pradyunsg/furo">Furo theme</a>.
            |
            <a class="muted-link" href="../../../../_sources/examples/AN00132_image_class/doc/rst/AN00132.rst.txt"
               rel="nofollow">
              Show Source
            </a>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Image class</a><ul>
<li><a class="reference internal" href="#overview">Overview</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#block-diagram">Block diagram</a></li>
</ul>
</li>
<li><a class="reference internal" href="#usb-still-image-capture-device-application-note">USB Still Image Capture Device Application Note</a><ul>
<li><a class="reference internal" href="#makefile-additions-for-this-example">Makefile additions for this example</a></li>
<li><a class="reference internal" href="#declaring-resource-and-setting-up-the-usb-components">Declaring resource and setting up the USB components</a></li>
<li><a class="reference internal" href="#the-application-main-function">The application main() function</a></li>
<li><a class="reference internal" href="#configuring-the-usb-device-id">Configuring the USB Device ID</a></li>
<li><a class="reference internal" href="#usb-still-image-capture-class-specific-defines">USB Still Image Capture Class specific defines</a></li>
<li><a class="reference internal" href="#usb-device-descriptor">USB Device Descriptor</a></li>
<li><a class="reference internal" href="#usb-configuration-descriptor">USB Configuration Descriptor</a></li>
<li><a class="reference internal" href="#usb-string-descriptors">USB string descriptors</a></li>
<li><a class="reference internal" href="#usb-still-image-capture-class-requests">USB Still Image Capture Class requests</a></li>
<li><a class="reference internal" href="#usb-still-image-capture-class-endpoint0">USB Still Image Capture Class Endpoint0</a></li>
<li><a class="reference internal" href="#handling-requests-to-the-bulk-endpoints">Handling requests to the bulk endpoints</a></li>
</ul>
</li>
<li><a class="reference internal" href="#example-hardware-setup">Example Hardware Setup</a></li>
<li><a class="reference internal" href="#host-application-setup">Host Application Setup</a><ul>
<li><a class="reference internal" href="#test-application">Test application</a></li>
<li><a class="reference internal" href="#licensing">Licensing</a></li>
<li><a class="reference internal" href="#compilation-instructions">Compilation instructions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#launching-the-demo-application">Launching the demo application</a><ul>
<li><a class="reference internal" href="#launching-from-the-command-line">Launching from the command line</a></li>
<li><a class="reference internal" href="#launching-from-xtimecomposer-studio">Launching from xTIMEcomposer Studio</a></li>
<li><a class="reference internal" href="#running-the-host-demo">Running the host demo</a></li>
</ul>
</li>
<li><a class="reference internal" href="#references">References</a></li>
<li><a class="reference internal" href="#full-source-code-listing">Full source code listing</a><ul>
<li><a class="reference internal" href="#source-code-for-endpoint0-xc">Source code for endpoint0.xc</a></li>
<li><a class="reference internal" href="#source-code-for-main-xc">Source code for main.xc</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </main>
</div>
    <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <script src="../../../../_static/tabs.js"></script>
    <script src="../../../../_static/scripts/main.js?digest=e931d09b2a40c1bb82b542effe772014573baf67"></script></body>
</html>