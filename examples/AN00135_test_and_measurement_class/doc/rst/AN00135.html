<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../../genindex.html" /><link rel="search" title="Search" href="../../../../search.html" /><link rel="next" title="Vendor Sepcific (Custom USB device)" href="../../../AN00136_vendor_specific/doc/rst/AN00136.html" /><link rel="prev" title="Image class" href="../../../AN00132_image_class/doc/rst/AN00132.html" />

    <meta name="generator" content="sphinx-3.5.4, furo 2021.04.11.beta34"/>
        <title>Test and Measurement class - Keith&#39;s Docs 23.2.17 documentation</title>
      <link rel="stylesheet" href="../../../../_static/styles/furo.css?digest=59ab60ac09ea94ccfe6deddff6d715cce948a6fc">
    <link rel="stylesheet" href="../../../../_static/pygments.css">
    <link media="(prefers-color-scheme: dark)" rel="stylesheet" href="../../../../_static/pygments_dark.css">
    


<style>
  :root {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
  }

  /* For allowing end-user-specific overrides */
  .override-light {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  .override-dark {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
  }
</style><link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/tabs.css" />
    <link rel="stylesheet" href="../../../../_static/styles/furo-extensions.css?digest=d391b54134226e4196576da3bdb6dddb7e05ba2b"></head>
  <body dir="">
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke-width="1.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z"/>
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../../index.html"><div class="brand">Keith's Docs 23.2.17 documentation</div></a>
    </div>
    <div class="header-right">
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand centered" href="../../../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../../../_static/xmos_logo.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Keith's Docs 23.2.17 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../../search.html">
  <input class="sidebar-search" placeholder=Search name="q">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../doc/rst/before_you_start.html">Before you start</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label for="toctree-checkbox-1"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/version_info.html">Tool and Architecture Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/inc_changelog.html">lib_xud Change Log</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/inc_license.html">XMOS PUBLIC LICENCE: Version 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/inc_copyrights.html">Copyright</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/inc_contributions.html">How to contribute</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/build_the_documentation_yourself.html">How to build the documenation</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../lib_xud/doc/rst/the_xud_library.html">The XUD library</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label for="toctree-checkbox-2"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib_xud/doc/rst/overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib_xud/doc/rst/file_arrangement.html">File Arrangement</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib_xud/doc/rst/resource_usage.html">Resource Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib_xud/doc/rst/basic_usage.html">Basic Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib_xud/doc/rst/advanced_usage.html">Advanced Usage</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../../../doc/usb_class_examples.html">USB Class examples</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label for="toctree-checkbox-3"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../AN00124_CDC_VCOM_class/doc/rst/AN00124.html">CDC VCOM class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00125_mass_storage_class/doc/rst/AN00125.html">Mass Storage class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00126_printer_class/doc/rst/AN00126.html">Printer class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00127_video_class/doc/rst/AN00127.html">Video class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00129_hid_class/doc/rst/AN00129.html">HID class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00131_CDC_EDC_class/doc/rst/AN00131.html">CDC EDC class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00132_image_class/doc/rst/AN00132.html">Image class</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Test and Measurement class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00136_vendor_specific/doc/rst/AN00136.html">Vendor Sepcific (Custom USB device)</a></li>
</ul>
</li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <main class="main">
    <div class="content">
      <article role="main">
        <label class="toc-overlay-icon toc-content-icon" for="__toc">
          <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
        </label>
        <div class="section" id="test-and-measurement-class">
<h1>Test and Measurement class<a class="headerlink" href="#test-and-measurement-class" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<div class="section" id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h3>
<p>The USB Test and Measurement class (USBTMC) specification allows the test and measurement devices with a USB interface so that messages can be exchanged between the host and devices.
The subclass specification communicates to the devices based on IEEE 488.1 (GPIB) and IEEE 488.2 (Standard Commands for Programmable Instruments - SCPI) standards.</p>
<p>These types of devices enumerate as Test and Measurement class USB devices on the host. A USBTMC device must be able to support the control endpoint, Bulk-OUT and Bulk-IN endpoints. The Interrupt-IN endpoint is optional and is used by the device to send notifications to the Host.</p>
<p>Examples of test and measurement devices includes</p>
<blockquote>
<div><ul class="simple">
<li><p>ADCs, DACs, Sensors, DAQs</p></li>
<li><p>Digital instrument cards, IEE-488 based communication devices</p></li>
</ul>
</div></blockquote>
<p>Each USBTMC device implements its own command set based on USBTMC subclass (IEEE488) standards.
Host can use any VISA compliant application to send these commands to the device and read the response from the device.</p>
</div>
<div class="section" id="block-diagram">
<h3>Block diagram<a class="headerlink" href="#block-diagram" title="Permalink to this headline">¶</a></h3>
<div class="figure align-center" id="id1">
<a class="reference internal image-reference" href="../../../../_images/block_diagram7.png"><img alt="../../../../_images/block_diagram7.png" src="../../../../_images/block_diagram7.png" style="width: 100%;"/></a>
<p class="caption"><span class="caption-number">Fig. 52 </span><span class="caption-text">Block diagram of USBTMC device application example</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>
<div class="section" id="usb-test-and-measurement-class-device-application-note">
<h2>USB Test and Measurement Class Device application note<a class="headerlink" href="#usb-test-and-measurement-class-device-application-note" title="Permalink to this headline">¶</a></h2>
<p>The application in this note uses the XMOS USB device library and creates a USBTMC device which responds to IVI-VISA compliant host application messages.
The device implements basic message requests for Bulk-IN and Bulk-OUT endpoints. Interrupt-IN endpoint is optional and is not used in this application. The application integrates an open source SCPI parser library and implements a minimal subset of SCPI commands to communicate with host. More SCPI commands can be easily added to this application by following the steps detailed in the <code class="docutils literal notranslate"><span class="pre">Using</span> <span class="pre">SCPI</span> <span class="pre">library</span> <span class="pre">to</span> <span class="pre">add</span> <span class="pre">more</span> <span class="pre">SCPI</span> <span class="pre">commands</span></code> appendix section.</p>
<p>For the USBTMC device class application example, the system comprises three tasks running on separate logical cores of an xCORE-USB multicore microcontroller.</p>
<p>The tasks perform the following operations.</p>
<blockquote>
<div><ul class="simple">
<li><p>A task containing the USB library functionality to communicate over USB</p></li>
<li><p>A task implementing Endpoint0 responding to standard USB control requests</p></li>
<li><p>A task implementing the USBTMC class specific message handling application code for both Bulk-IN and Bulk-OUT endpoints</p></li>
</ul>
</div></blockquote>
<p>These tasks communicate via the use of xCONNECT channels which allow data to be passed between application code running on the separate logical cores.</p>
<p>The following diagram shows the task and communication structure for this USBTMC application example.</p>
<div class="figure align-default" id="id2">
<img alt="../../../../_images/task_diagram6.png" src="../../../../_images/task_diagram6.png"/>
<p class="caption"><span class="caption-number">Fig. 53 </span><span class="caption-text">Task diagram of USBTMC device</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<div class="section" id="makefile-additions-for-this-example">
<h3>Makefile additions for this example<a class="headerlink" href="#makefile-additions-for-this-example" title="Permalink to this headline">¶</a></h3>
<p>To start using the USB library, you need to add <code class="docutils literal notranslate"><span class="pre">lib_xud</span></code> to your makefile:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">USED_MODULES</span> <span class="o">=</span> <span class="o">...</span> <span class="n">lib_xud</span> <span class="o">...</span>
</pre></div>
</div>
<p>You can then access the USB functions in your source code via the xud.h header file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;usb_device.h&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="declaring-resource-and-setting-up-the-usb-components">
<h3>Declaring resource and setting up the USB components<a class="headerlink" href="#declaring-resource-and-setting-up-the-usb-components" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">main.xc</span></code> contains the logical cores instantiation needed for USBTMC device. There are some defines in it that are used to configure the XMOS USB device library. These are displayed below.</p>
<p>This set of defines describes the endpoint configuration for this device. This example has bi-directional communication with the host machine via the standard endpoint0 and endpoints for implementing the bulk-in and bulk-out endpoints.</p>
<p>These defines are passed to the setup function for the USB library which is called
from <code class="docutils literal notranslate"><span class="pre">main()</span></code>.</p>
</div>
<div class="section" id="the-application-main-function">
<h3>The application main() function<a class="headerlink" href="#the-application-main-function" title="Permalink to this headline">¶</a></h3>
<p>Below is the source code for the main function of this application, which is taken from
the source file <code class="docutils literal notranslate"><span class="pre">main.xc</span></code></p>
<p>Looking at this in a more detail you can see the following:</p>
<blockquote>
<div><ul class="simple">
<li><p>The par functionality describes running three separate tasks in parallel</p></li>
<li><p>There is a function call to configure and execute the USB library: <code class="docutils literal notranslate"><span class="pre">xud()</span></code></p></li>
<li><p>There is a function call to start up and run the Endpoint0 code: <code class="docutils literal notranslate"><span class="pre">Endpoint0()</span></code></p></li>
<li><p>There is a function to deal with the USBTMC device custom bulk endpoints <code class="docutils literal notranslate"><span class="pre">usbtmc_bulk_endpoints()</span></code></p></li>
<li><p>The define USB_TILE describes the tile on which the individual tasks will run</p></li>
<li><p>In this example all tasks run on the same tile as the USB PHY although this is only a requirement of <code class="docutils literal notranslate"><span class="pre">xud()</span></code></p></li>
<li><p>The xCONNECT communication channels used by the application are set up at the beginning of <code class="docutils literal notranslate"><span class="pre">main()</span></code></p></li>
<li><p>The USB defines discussed earlier are passed into the function <code class="docutils literal notranslate"><span class="pre">xud</span></code></p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="configuring-the-usb-device-id">
<h3>Configuring the USB Device ID<a class="headerlink" href="#configuring-the-usb-device-id" title="Permalink to this headline">¶</a></h3>
<p>The USB ID values used for Vendor ID (VID), Product ID (PID) and device version number are defined in the file <code class="docutils literal notranslate"><span class="pre">endpoint0.xc</span></code>. These are used by the host machine to determine the vendor of the device (in this case XMOS) and the product plus the firmware version.</p>
</div>
<div class="section" id="usbtmc-class-specific-defines">
<h3>USBTMC Class specific defines<a class="headerlink" href="#usbtmc-class-specific-defines" title="Permalink to this headline">¶</a></h3>
<p>The USBTMC class is configured in the file <code class="docutils literal notranslate"><span class="pre">endpoint0.xc</span></code>.
Below there are a set of standard defines which are used to configure the
USB device descriptors to setup a USBTMC device running on an xCORE-USB microcontroller.</p>
<p>These are defined in the USB standard as required in the device description for
TMC class devices and for configuring them as such with the USB host machine.</p>
</div>
<div class="section" id="usb-device-descriptor">
<h3>USB Device Descriptor<a class="headerlink" href="#usb-device-descriptor" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">endpoint0.xc</span></code> is where the standard USB device descriptor is declared for a USBTMC class device. Below is the structure which contains this descriptor. This will be requested by the host when the device is enumerated on the USB bus. This descriptor contains the vendor specific defines described above.</p>
<p>From this descriptor you can see that product, vendor and device firmware revision are all coded into this structure. This will allow the host machine to recognise our USBTMC device when it is connected to the USB bus.</p>
</div>
<div class="section" id="usb-configuration-descriptor">
<h3>USB Configuration Descriptor<a class="headerlink" href="#usb-configuration-descriptor" title="Permalink to this headline">¶</a></h3>
<p>The USB configuration descriptor is used to configure the device class and the endpoint setup. For the USBTMC device provided in this example the configuration descriptor which is read by the host is as follows.</p>
<p>This descriptor is in the format described by the USB 2.0 standard and contains the encoding for the endpoints related to control endpoint 0 and also the descriptors that describe the 2 bulk endpoints which form our USBTMC device.
Note that bInterfaceProtocol value is controlled by the define USBTMC_SUB_CLASS_SUPPORT and it is set to <code class="docutils literal notranslate"><span class="pre">0</span></code> implying that no subclass specification applies and the USBTMC interface is not required to have an Interrupt-IN endpoint for this application example.</p>
</div>
<div class="section" id="usb-string-descriptors">
<h3>USB string descriptors<a class="headerlink" href="#usb-string-descriptors" title="Permalink to this headline">¶</a></h3>
<p>The final descriptor for our USBTMC device is the string descriptor which the host machine uses to report to the user when the device is enumerated and when the user queries the device on the host system. This is setup as follows.</p>
<p>The last value corresponds to the iSerialNumber of the device, which should contain a value &gt; 0 to form a valid GUID.</p>
</div>
<div class="section" id="usbtmc-endpoint0">
<h3>USBTMC Endpoint0<a class="headerlink" href="#usbtmc-endpoint0" title="Permalink to this headline">¶</a></h3>
<p>The function <code class="docutils literal notranslate"><span class="pre">Endpoint0()</span></code> contains the code for dealing with device requests made from
the host to the standard endpoint0 which is present in all USB devices.</p>
<p>The control interface class requests are handled using the below function.</p>
<p>This application implements <code class="docutils literal notranslate"><span class="pre">GET_CAPABILITIES</span></code> request and uses it to send our device capabilities to the host.</p>
</div>
<div class="section" id="handling-requests-to-the-usbtmc-bulk-endpoints">
<h3>Handling requests to the USBTMC bulk endpoints<a class="headerlink" href="#handling-requests-to-the-usbtmc-bulk-endpoints" title="Permalink to this headline">¶</a></h3>
<p>The application endpoints for receiving and transmitting to the host machine are implemented in the file <code class="docutils literal notranslate"><span class="pre">usbtmc_endpoints.xc</span></code>. This is contained within the function <code class="docutils literal notranslate"><span class="pre">usbtmc_bulk_endpoints()</span></code> which is shown below:</p>
<p>From this you can see the following.</p>
<blockquote>
<div><ul class="simple">
<li><p>A buffer is declared to communicate and transfer data with the host <code class="docutils literal notranslate"><span class="pre">host_transfer_buf</span></code> of size BUFFER_SIZE.</p></li>
<li><p>Bulk-OUT endpoint is set as ready to receive the data from the host</p></li>
<li><p>SCPI parser library is initialized using <code class="docutils literal notranslate"><span class="pre">SCPI_initialize_parser</span></code> wrapper api call</p></li>
<li><p>This task operates inside a <code class="docutils literal notranslate"><span class="pre">while</span> <span class="pre">(1)</span></code> loop which has a select handler to repeatedly deal with events related to bulk endpoints</p></li>
<li><p>The select event handler gets the data from bulk out endpoint, decodes the USBTMC device dependent command messages using SCPI command parser</p></li>
<li><p>The function <code class="docutils literal notranslate"><span class="pre">SCPI_parse_cmd</span></code> parses the USBTMC device dependent command message, prepares a response message and sends the response using the bulk-in endpoint using <code class="docutils literal notranslate"><span class="pre">XUD_SetReady_In</span></code></p></li>
<li><p>The Bulk-OUT endpoint is set as ready once again to receive the data from the host</p></li>
<li><p>This vendor specific command requests and responses could also be handled in a similar manner</p></li>
</ul>
</div></blockquote>
<p><a href="#id8"><span class="problematic" id="id9">|appendix|</span></a></p>
</div>
</div>
<div class="section" id="example-hardware-setup">
<h2>Example Hardware Setup<a class="headerlink" href="#example-hardware-setup" title="Permalink to this headline">¶</a></h2>
<p>To run the example, connect the xCORE-USB sliceKIT USB-B and xTAG-2 USB-A
connectors to separate USB connectors on your development PC.</p>
<p>On the xCORE-USB sliceKIT ensure that the xCONNECT LINK switch is set to ON, as per the image,
to allow xSCOPE to function. The use of xSCOPE is required in this application so
that the print messages that are generated on the device as part of the demo
do not interfere with the real-time behavior of the USB device.</p>
<div class="figure align-default" id="id3">
<img alt="../../../../_images/usb-slicekit7.png" src="../../../../_images/usb-slicekit7.png"/>
<p class="caption"><span class="caption-number">Fig. 54 </span><span class="caption-text">XMOS xCORE-USB sliceKIT</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
<p>The hardware should be configured as displayed above for this demo:</p>
<blockquote>
<div><ul class="simple">
<li><p>The XTAG debug adapter should be connected to the XSYS connector and
the XTAG USB cable should be connected to the host machine</p></li>
<li><p>The xCORE-USB core board should have a USB cable connecting the device
to the host machine</p></li>
<li><p>The xSCOPE switch on the board should be set to the on position</p></li>
<li><p>The xCORE-USB core board should have the power cable connected</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="launching-the-demo-application">
<h2>Launching the demo application<a class="headerlink" href="#launching-the-demo-application" title="Permalink to this headline">¶</a></h2>
<p>Once the demo example has been built either from the command line using
xmake or via the build mechanism of xTIMEcomposer studio the application
can be executed on the xCORE-USB sliceKIT.</p>
<p>Once built there will be a <code class="docutils literal notranslate"><span class="pre">bin</span></code> directory within the project which
contains the binary for the xCORE device. The xCORE binary has a XMOS standard
.xe extension.</p>
<div class="section" id="launching-from-the-command-line">
<h3>Launching from the command line<a class="headerlink" href="#launching-from-the-command-line" title="Permalink to this headline">¶</a></h3>
<p>From the command line the <code class="docutils literal notranslate"><span class="pre">xrun</span></code> tool is used to download code to the
xCORE-USB device. Changing into the bin directory of the project
the code can be executed on the xCORE microcontroller as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">xrun</span> <span class="n">app_usb_tmc_demo</span><span class="o">.</span><span class="n">xe</span>          <span class="o">&lt;--</span> <span class="n">Download</span> <span class="ow">and</span> <span class="n">execute</span> <span class="n">the</span> <span class="n">xCORE</span> <span class="n">code</span>
</pre></div>
</div>
<p>Once this command has executed the USBTMC device should have
enumerated on the host machine</p>
</div>
<div class="section" id="launching-from-xtimecomposer-studio">
<h3>Launching from xTIMEcomposer Studio<a class="headerlink" href="#launching-from-xtimecomposer-studio" title="Permalink to this headline">¶</a></h3>
<p>From xTIMEcomposer Studio the run mechanism is used to download code to the
xCORE device. Select the xCORE binary from the bin directory, right click
and then run as xCORE application will execute the code on the xCORE device.</p>
<p>Once this command has executed the USBTMC device should have
enumerated on your machine</p>
</div>
<div class="section" id="running-the-usbtmc-demo">
<h3>Running the USBTMC demo<a class="headerlink" href="#running-the-usbtmc-demo" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>Ensure the USBTMC device enumeration on a Linux (Ubuntu 12.04 LTS) host is fine:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>xmos@xmos:~$ lsusb
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 001 Device 012: ID 20b1:2337 XMOS Ltd
</pre></div>
</div>
</li>
<li><p>List the details of the device descriptor:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@xmos</span><span class="o">-</span><span class="n">lenovo</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">xmos</span><span class="c1"># lsusb -v</span>
<span class="o">&gt;</span> <span class="n">lsusb</span> <span class="o">-</span><span class="n">v</span>
<span class="n">Bus</span> <span class="mi">001</span> <span class="n">Device</span> <span class="mi">012</span><span class="p">:</span> <span class="n">ID</span> <span class="mi">20</span><span class="n">b1</span><span class="p">:</span><span class="mi">2337</span> <span class="n">XMOS</span> <span class="n">Ltd</span>
<span class="n">Device</span> <span class="n">Descriptor</span><span class="p">:</span>
  <span class="n">bLength</span>                <span class="mi">18</span>
  <span class="n">bDescriptorType</span>         <span class="mi">1</span>
  <span class="n">bcdUSB</span>               <span class="mf">2.00</span>
  <span class="n">bDeviceClass</span>            <span class="mi">0</span> <span class="p">(</span><span class="n">Defined</span> <span class="n">at</span> <span class="n">Interface</span> <span class="n">level</span><span class="p">)</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">idVendor</span>           <span class="mh">0x20b1</span> <span class="n">XMOS</span> <span class="n">Ltd</span>
  <span class="n">idProduct</span>          <span class="mh">0x2337</span>
  <span class="n">bcdDevice</span>            <span class="mf">1.26</span>
  <span class="n">iManufacturer</span>           <span class="mi">1</span> <span class="n">XMOS</span>
  <span class="n">iProduct</span>                <span class="mi">2</span> <span class="n">XMOS</span> <span class="n">TestMeasuement</span> <span class="n">device</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="n">Interface</span> <span class="n">Descriptor</span><span class="p">:</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">bInterfaceClass</span>       <span class="mi">254</span> <span class="n">Application</span> <span class="n">Specific</span> <span class="n">Interface</span>
  <span class="n">bInterfaceSubClass</span>      <span class="mi">3</span> <span class="n">Test</span> <span class="ow">and</span> <span class="n">Measurement</span>
  <span class="n">bInterfaceProtocol</span>      <span class="mi">0</span>
  <span class="n">iInterface</span>              <span class="mi">3</span> <span class="n">USBTMC</span>
  <span class="n">Endpoint</span> <span class="n">Descriptor</span><span class="p">:</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">bEndpointAddress</span>     <span class="mh">0x01</span>  <span class="n">EP</span> <span class="mi">1</span> <span class="n">OUT</span>
  <span class="n">bmAttributes</span>            <span class="mi">2</span>
    <span class="n">Transfer</span> <span class="n">Type</span>            <span class="n">Bulk</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="n">bEndpointAddress</span>     <span class="mh">0x81</span>  <span class="n">EP</span> <span class="mi">1</span> <span class="n">IN</span>
<span class="n">bmAttributes</span>            <span class="mi">2</span>
    <span class="n">Transfer</span> <span class="n">Type</span>            <span class="n">Bulk</span>
  <span class="o">.</span>
  <span class="o">.</span>
</pre></div>
</div>
</li>
<li><p>Open a <cite>Terminal</cite> window (using root privileges) and communicate with the XMOS USBTMC device:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@xmos</span><span class="o">-</span><span class="n">lenovo</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">xmos</span><span class="c1"># python</span>
<span class="n">Python</span> <span class="mf">2.7.3</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Aug</span>  <span class="mi">1</span> <span class="mi">2012</span><span class="p">,</span> <span class="mi">05</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">07</span><span class="p">)</span>
<span class="p">[</span><span class="n">GCC</span> <span class="mf">4.6.3</span><span class="p">]</span> <span class="n">on</span> <span class="n">linux2</span>
<span class="n">Type</span> <span class="s2">"help"</span><span class="p">,</span> <span class="s2">"copyright"</span><span class="p">,</span> <span class="s2">"credits"</span> <span class="ow">or</span> <span class="s2">"license"</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="o">.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">usb.core</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">usb.util</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">usb</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">idVendor</span><span class="o">=</span><span class="mh">0x20b1</span><span class="p">,</span> <span class="n">idProduct</span><span class="o">=</span><span class="mh">0x2337</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">usbtmc</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">instr</span> <span class="o">=</span>  <span class="n">usbtmc</span><span class="o">.</span><span class="n">Instrument</span><span class="p">(</span><span class="mh">0x20b1</span><span class="p">,</span> <span class="mh">0x2337</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Identify the USBTMC device using IDN query:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">"*IDN?"</span><span class="p">))</span>
<span class="go">XMOS, USBTMC, 1, 01-01</span>

<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">"*RST"</span><span class="p">))</span>
<span class="go">SCPI command not implemented</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
</li>
<li><p>Query the DC voltage of the device using the SCPI command as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">"*MEASure:VOLTage:DC?"</span><span class="p">))</span>
<span class="go">10</span>
</pre></div>
</div>
</li>
</ul>
<p>Note: The DC voltage measurement function is stubbed inside the device code to return a sample voltage value. This logic can be replaced with instrument data such as actual ADC results.</p>
</div>
</div>
<div class="section" id="using-ni-labview-to-communicate-with-xmos-usbtmc-device">
<h2>Using NI LabVIEW to communicate with XMOS USBTMC device<a class="headerlink" href="#using-ni-labview-to-communicate-with-xmos-usbtmc-device" title="Permalink to this headline">¶</a></h2>
<p>NI LabVIEW software can communicate with USBTMC devices using VISA functions (Read, Write, Open, Close) in the same way as you would communicate with GPIB instruments. You can create a simple block diagram as below.</p>
<div class="figure align-default" id="id4">
<img alt="../../../../_images/ni_labview_block_diagram.png" src="../../../../_images/ni_labview_block_diagram.png"/>
<p class="caption"><span class="caption-number">Fig. 55 </span><span class="caption-text">NI LabVIEW block diagram to communicate to XMOS USBTMC device</span><a class="headerlink" href="#id4" title="Permalink to this image">¶</a></p>
</div>
<p>This example opens a VISA session, uses a SCPI command to query the ID of the device and the response is read back before closing the session. To test this block, connect your device to a host and ensure it successfully enumerates as USBTMC device as follows.</p>
<div class="figure align-default" id="id5">
<img alt="../../../../_images/win_device_list.png" src="../../../../_images/win_device_list.png"/>
<p class="caption"><span class="caption-number">Fig. 56 </span><span class="caption-text">XMOS device enumerated as USBTMC device on a Windows 7 host</span><a class="headerlink" href="#id5" title="Permalink to this image">¶</a></p>
</div>
<p>Navigate to the NI LabVIEW front panel window of the block diagram and select XMOS USBTMC device in the VISA IO resource listing.</p>
<div class="figure align-default" id="id6">
<img alt="../../../../_images/ni-front-panel.png" src="../../../../_images/ni-front-panel.png"/>
<p class="caption"><span class="caption-number">Fig. 57 </span><span class="caption-text">NI LabVIEW front panel to select XMOS USBTMC device</span><a class="headerlink" href="#id6" title="Permalink to this image">¶</a></p>
</div>
<p>Click <cite>Run</cite> button (Right arrow). The device id of the manufacturer, which is <cite>XMOS USBTMC device with version number</cite> in this case is populated in the results buffer as follows.</p>
<div class="figure align-default" id="id7">
<img alt="../../../../_images/ni_labview_results.png" src="../../../../_images/ni_labview_results.png"/>
<p class="caption"><span class="caption-number">Fig. 58 </span><span class="caption-text">NI LabVIEW front panel displaying results from XMOS USBTMC device</span><a class="headerlink" href="#id7" title="Permalink to this image">¶</a></p>
</div>
<p>Similarly you can alter the query from the block diagram to contain a different SCPI command (for e.g., <code class="docutils literal notranslate"><span class="pre">*MEASure:VOLTage:DC?</span></code>), submit it to your device and record the new results.</p>
</div>
<div class="section" id="using-scpi-library-to-add-more-scpi-commands">
<h2>Using SCPI library to add more SCPI commands<a class="headerlink" href="#using-scpi-library-to-add-more-scpi-commands" title="Permalink to this headline">¶</a></h2>
<p>The application supports very minimum SCPI commands on the device. Adding more SCPI commands is a simple configuration because the device code ports an Open source SCPI library. In order to add more SCPI commands, follow the below steps.</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Navigate to <code class="docutils literal notranslate"><span class="pre">src\scpi_parser\custom\scpi_parser_config.c</span></code> file</p></li>
<li><p>Add SCPI command to the <code class="docutils literal notranslate"><span class="pre">scpi_commands</span></code> structure and attach a callback function</p></li>
<li><p>Declare the callback function in <code class="docutils literal notranslate"><span class="pre">src\scpi_parser\custom\scpi_cmds.h</span></code> file</p></li>
<li><p>Source file <code class="docutils literal notranslate"><span class="pre">src\scpi_parser\custom\scpi_cmds.c</span></code> contains the definition of callback functions. These functions interface with device measurement logic in order to capture the instrument results. Define the callback function logic for the configured SCPI command in this file.</p></li>
<li><p>When the USBTMC host client software uses the corresponding SCPI command, this callback function is invoked and the computed result is sent back to the host as response message using the existing framework.</p></li>
</ol>
</div></blockquote>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="full-source-code-listing">
<h2>Full source code listing<a class="headerlink" href="#full-source-code-listing" title="Permalink to this headline">¶</a></h2>
<div class="section" id="source-code-for-endpoint0-xc">
<h3>Source code for endpoint0.xc<a class="headerlink" href="#source-code-for-endpoint0-xc" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="source-code-for-usbtmc-endpoints-xc">
<h3>Source code for usbtmc_endpoints.xc<a class="headerlink" href="#source-code-for-usbtmc-endpoints-xc" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="source-code-for-main-xc">
<h3>Source code for main.xc<a class="headerlink" href="#source-code-for-main-xc" title="Permalink to this headline">¶</a></h3>
</div>
</div>
</div>

      </article>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../../../AN00136_vendor_specific/doc/rst/AN00136.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Vendor Sepcific (Custom USB device)</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../../../AN00132_image_class/doc/rst/AN00132.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Image class</div>
                
              </div>
            </a>
        </div>

        <div class="related-information">
              Copyright &#169; 2021, XMOS Ltd
            |
            Built with <a href="https://www.sphinx-doc.org/">Sphinx</a>
              and
              <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
              <a href="https://github.com/pradyunsg/furo">Furo theme</a>.
            |
            <a class="muted-link" href="../../../../_sources/examples/AN00135_test_and_measurement_class/doc/rst/AN00135.rst.txt"
               rel="nofollow">
              Show Source
            </a>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Test and Measurement class</a><ul>
<li><a class="reference internal" href="#overview">Overview</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#block-diagram">Block diagram</a></li>
</ul>
</li>
<li><a class="reference internal" href="#usb-test-and-measurement-class-device-application-note">USB Test and Measurement Class Device application note</a><ul>
<li><a class="reference internal" href="#makefile-additions-for-this-example">Makefile additions for this example</a></li>
<li><a class="reference internal" href="#declaring-resource-and-setting-up-the-usb-components">Declaring resource and setting up the USB components</a></li>
<li><a class="reference internal" href="#the-application-main-function">The application main() function</a></li>
<li><a class="reference internal" href="#configuring-the-usb-device-id">Configuring the USB Device ID</a></li>
<li><a class="reference internal" href="#usbtmc-class-specific-defines">USBTMC Class specific defines</a></li>
<li><a class="reference internal" href="#usb-device-descriptor">USB Device Descriptor</a></li>
<li><a class="reference internal" href="#usb-configuration-descriptor">USB Configuration Descriptor</a></li>
<li><a class="reference internal" href="#usb-string-descriptors">USB string descriptors</a></li>
<li><a class="reference internal" href="#usbtmc-endpoint0">USBTMC Endpoint0</a></li>
<li><a class="reference internal" href="#handling-requests-to-the-usbtmc-bulk-endpoints">Handling requests to the USBTMC bulk endpoints</a></li>
</ul>
</li>
<li><a class="reference internal" href="#example-hardware-setup">Example Hardware Setup</a></li>
<li><a class="reference internal" href="#launching-the-demo-application">Launching the demo application</a><ul>
<li><a class="reference internal" href="#launching-from-the-command-line">Launching from the command line</a></li>
<li><a class="reference internal" href="#launching-from-xtimecomposer-studio">Launching from xTIMEcomposer Studio</a></li>
<li><a class="reference internal" href="#running-the-usbtmc-demo">Running the USBTMC demo</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-ni-labview-to-communicate-with-xmos-usbtmc-device">Using NI LabVIEW to communicate with XMOS USBTMC device</a></li>
<li><a class="reference internal" href="#using-scpi-library-to-add-more-scpi-commands">Using SCPI library to add more SCPI commands</a></li>
<li><a class="reference internal" href="#references">References</a></li>
<li><a class="reference internal" href="#full-source-code-listing">Full source code listing</a><ul>
<li><a class="reference internal" href="#source-code-for-endpoint0-xc">Source code for endpoint0.xc</a></li>
<li><a class="reference internal" href="#source-code-for-usbtmc-endpoints-xc">Source code for usbtmc_endpoints.xc</a></li>
<li><a class="reference internal" href="#source-code-for-main-xc">Source code for main.xc</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </main>
</div>
    <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <script src="../../../../_static/tabs.js"></script>
    <script src="../../../../_static/scripts/main.js?digest=e931d09b2a40c1bb82b542effe772014573baf67"></script></body>
</html>